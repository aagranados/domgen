/* DO NOT EDIT: File is autogenerated */
package <%= object_type.schema.java.package %>.persist;
<%
set_iris_mode

fqn = j_classname(object_type.java.fully_qualified_name)
%>

@javax.annotation.Generated( "Domgen" )
@SuppressWarnings( { "UnusedDeclaration" } )
public final class <%= object_type.java.classname %>PersistPeer
   extends iris.persist.DatabasePeer
{
  protected Class<<%= fqn %>> getPersistentClass()
  {
    return <%= fqn %>.class;
  }

  public java.util.List<java.util.Map<String, Object>> restoreDataSet( final java.util.Map<String,Object> criteria, final java.sql.Connection connection )
      throws iris.beans.MissingBeanException
  {
    final java.util.List<java.util.Map<String, Object>> list = super.restoreDataSet( criteria, connection );
    final iris.beans.store.DataStore dataStore = iris.beans.BeanFactory.getManager().getDataStore();
    for ( final java.util.Map<String, Object> resultData : list )
    {
      dataStore.registerObjectData( getPersistentClass(), resultData );
    }
    return list;
  }

  protected String handleCriterion( final java.util.Map criteria )
  {
    final StringBuilder sb = new StringBuilder();
<% object_type.attributes.select {|a| a.persistent? && !a.iris.runtime_managed?}.each do |attribute|
     upper_name = uppercase_constantize(attribute.name)
%>    if ( criteria.containsKey( <%= fqn %>.COLUMN_<%= upper_name %> ) )
    {
      prepareAppend( sb );
      sb.append( <%= fqn %>.COLUMN_<%= upper_name %> );
      columnCriterionMatch( sb, criteria.get( <%= fqn %>.COLUMN_<%= upper_name %> ) );
    }
<%
  end
  object_type.iris.criteria.select{|c| !c.code_based?}.each do |criterion|
%>    if ( criteria.containsKey( <%= fqn %>.QUERY_<%= uppercase_constantize(criterion.name) %> ) )
    {
      final String[] values = prepareSQLArray( criteria.get( <%= fqn %>.QUERY_<%= uppercase_constantize(criterion.name) %> ) );
      final java.text.MessageFormat format = new java.text.MessageFormat( "<%= criterion.sql %>" );
      final String sql = format.format( values );
      prepareAppend( sb );
      sb.append( sql );
    }
<% end
  object_type.iris.criteria.select{|c| c.code_based?}.each do |criterion|
%>    if ( criteria.containsKey( <%= fqn %>.QUERY_<%= uppercase_constantize(criterion.name) %> ) )
    {
      prepareAppend( sb );
      sb.append( <%= object_type.java.classname %>PersistHelper.handle<%= criterion.name %>Criterion( (<%= criterion.java_parameter_type %>)criteria.get( <%= fqn %>.QUERY_<%= uppercase_constantize(criterion.name) %> ) ) );
    }
<% end
%>    return sb.toString();
  }

  protected String handleSelection()
  {
    final StringBuffer sb = new StringBuffer();

    sb.append( iris.busobj.BusObjEntry.BATCH_ID );
    sb.append( COMMA );
    sb.append( iris.busobj.BusObjEntry.TO_DATE );
<% object_type.attributes.select {|a| a.persistent? && !a.iris.runtime_managed?}.each do |attribute| 
%>    sb.append( COMMA );
    sb.append( <%= fqn %>.COLUMN_<%= uppercase_constantize(attribute.name) %> );
<% end %>
    return sb.toString();
  }

  protected String getTableName()
  {
    return <%= fqn %>.TABLE_NAME;
  }

  protected String getRemoveSql( final iris.beans.AbstractBean persistent )
  {
    final <%= fqn %> value = (<%= fqn %>)persistent;
    final iris.busobj.BusObjEntry entry = iris.busobj.BusObjEntry.getEntry( value );
    final StringBuilder sb = new StringBuilder();
    sb.append( UPDATE );
    sb.append( quote( getTableName() ) );
    sb.append( SET );
    sb.append( iris.busobj.BusObjEntry.TO_DATE );
    sb.append( EQUALS );
    sb.append( prepareSQL( entry.getToDate() ) );
    sb.append( COMMA );
    sb.append( iris.busobj.BusObjEntry.BATCH_ID );
    sb.append( EQUALS );
    sb.append( prepareSQL( entry.getBatchID() ) );
    sb.append( WHERE );
    sb.append( ID );
    sb.append( EQUALS );
    sb.append( prepareSQL( value.get<%= object_type.primary_key.java.field_name %>() ) );
    return sb.toString();
  }

  protected String getUpdateSql( final iris.beans.AbstractBean persistent )
  {
<%
  mutable_attributes = object_type.attributes.select {|a| !a.primary_key? && !a.immutable? && a.persistent? && !a.iris.runtime_managed?}
if mutable_attributes.size == 0
%>    return null;
<% else %>
    <%= object_type.schema.java.package %>.<%= object_type.schema.name %>Validator.validate( persistent );
    final <%= fqn %> value = (<%= fqn %>)persistent;

    final StringBuilder sb = new StringBuilder();
    sb.append( UPDATE );
    sb.append( getTableName() );
    sb.append( SET );
    sb.append( quote( iris.busobj.BusObjEntry.BATCH_ID ) );
    sb.append( EQUALS );
    sb.append( prepareSQL( iris.busobj.BusObjEntry.getEntry( persistent ).getBatchID() ) );
<% mutable_attributes.each do |attribute|
%>    sb.append( COMMA );
    sb.append( quote( <%= fqn %>.COLUMN_<%= uppercase_constantize(attribute.name) %> ) );
    sb.append( EQUALS );
    sb.append( prepareSQL( value.get<%= attribute.java.field_name %>() ) );
<% end
%>    sb.append( WHERE );
    sb.append( ID );
    sb.append( EQUALS );
    sb.append( prepareSQL( value.get<%= object_type.primary_key.java.field_name %>() ) );
    return sb.toString();
<% end %>  }

  protected String getInsertSql( final iris.beans.AbstractBean persistent )
  {
    <%= object_type.schema.java.package %>.<%= object_type.schema.name %>Validator.validate( persistent );
    final <%= fqn %> value = (<%= fqn %>)persistent;
    final iris.busobj.BusObjEntry entry = iris.busobj.BusObjEntry.getEntry( value );
    final StringBuffer sb = new StringBuffer();
    sb.append( INSERT_INTO );
    sb.append( getTableName() );
    sb.append( " (" );
    sb.append( quote( iris.busobj.BusObjEntry.BATCH_ID ) );
    sb.append( COMMA );
    sb.append( quote( iris.busobj.BusObjEntry.TO_DATE ) );
<% object_type.attributes.select {|a| a.persistent? && !a.iris.runtime_managed?}.each do |attribute|
%>    sb.append( COMMA );
    sb.append( quote( <%= fqn %>.COLUMN_<%= uppercase_constantize(attribute.name) %> ) );
<% end %>
    sb.append( VALUES );
    sb.append( prepareSQL( entry.getBatchID() ) );
    sb.append( COMMA );
    sb.append( prepareSQL( entry.getToDate() ) );
<% object_type.attributes.select {|a| a.persistent? && !a.iris.runtime_managed?}.each do |attribute|
%>    sb.append( COMMA );
    sb.append( prepareSQL( value.get<%= attribute.java.field_name %>() ) );
<% end
%>    sb.append( ")" );
    return sb.toString();
  }

  protected void prepareQueryTail( final StringBuilder sb, final java.util.Map<String,Object> criteria )
  {
    boolean order = false;
    if ( null != criteria && criteria.containsKey( INCLUDE_DELETED ) )
    {
      order = true;
    }
    else if ( null != criteria && criteria.containsKey( iris.busobj.BusObjEntry.BATCH_ID ) )
    {
      prepareAppend( sb );
      sb.append( iris.busobj.BusObjEntry.BATCH_ID );
      sb.append( EQUALS );
      sb.append( criteria.get( iris.busobj.BusObjEntry.BATCH_ID ) );
    }
    else
    {
      prepareAppend( sb );
      sb.append( getCurrentTimeCriteria() );
      order = true;
    }

    if ( order )
    {
      if ( null != criteria && !criteria.containsKey( NO_ORDER_BY ) )
      {
        final String orderBy = getOrderBy( criteria, null );
        sb.append( orderBy );
        if ( !"".equals( orderBy ) && criteria.containsKey( ORDER_BY_DESC ) )
        {
          sb.append( DESC );
        }
      }
    }
  }

  @Override
  protected String getDeclarations( final java.util.Map<String, Object> criteria )
  {
    return <%= (object_type.name == :SpecificTask) ? "SpecificTaskPersistHelper.getDeclarations( criteria )" : "\"\"" %>;
  }
}
