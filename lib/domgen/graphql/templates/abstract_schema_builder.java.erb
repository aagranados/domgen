/* DO NOT EDIT: File is auto-generated */
package <%= to_package(repository.graphql.qualified_abstract_schema_builder_name) %>;

@javax.annotation.Generated( "Domgen" )
@java.lang.SuppressWarnings( { "UnusedDeclaration", "JavaDoc" } )
public abstract class <%= repository.graphql.abstract_schema_builder_name %>
  extends org.realityforge.graphql.domgen.AbstractGraphQLSchemaProvider
{
  @java.lang.Override
  protected void populateGraphQLSchema()
  {
    registerScalarTypes();
    registerEnumTypes();
    registerObjectTypes();
    resolveInterfaceTypeResolvers();
  }

  protected void registerScalarTypes()
  {
<% repository.graphql.non_standard_scalars.each do |scalar| -%>
    {
      final graphql.schema.GraphQLScalarType scalar = defineScalar_<%= scalar %>();
      registerScalarType( scalar );
    }
<% end -%>
    registerStandardScalarTypes();
  }

  protected void registerEnumTypes()
  {
<% repository.data_modules.select{|data_module| data_module.graphql?}.each do |data_module| -%>
<% data_module.enumerations.select{|enumeration| enumeration.graphql? }.each do |enumeration| -%>
    {
      final graphql.schema.GraphQLEnumType enumType = defineEnumType_<%= data_module.name %>_<%= enumeration.name %>();
      registerEnumType( enumType );
    }
<% end -%>
<% end -%>
  }

  protected void registerObjectTypes()
  {
<% repository.data_modules.select{|data_module| data_module.graphql?}.each do |data_module| -%>
<% data_module.entities.select{|entity| entity.graphql? }.each do |entity| -%>
<% if entity.abstract? -%>
    {
      final graphql.schema.GraphQLInterfaceType interfaceType = defineInterfaceType_<%= data_module.name %>_<%= entity.name %>();
      registerInterfaceType( interfaceType );
    }
<% else -%>
    {
      final graphql.schema.GraphQLObjectType objectType = defineObjectType_<%= data_module.name %>_<%= entity.name %>();
      registerObjectType( objectType );
    }
<% end -%>
<% end -%>
<% end -%>
  }

  protected void resolveInterfaceTypeResolvers()
  {
<% repository.data_modules.select{|data_module| data_module.graphql?}.each do |data_module| -%>
<% data_module.entities.select{|entity| entity.graphql? }.each do |entity| -%>
<% if entity.abstract? -%>
    {
      final graphql.schema.TypeResolver resolver =
        new org.realityforge.graphql.domgen.SimpleTypeResolver.Builder().
<% entity.subtypes.select{|st|st.concrete? && st.jpa?}.each do |st| -%>
        add( <%= st.jpa.qualified_name %>.class, objectType( "<%= st.graphql.name %>" ) ).
<% end -%>
        build();
      ( (graphql.schema.TypeResolverProxy) interfaceType( "<%= entity.graphql.name %>" ).getTypeResolver() ).setTypeResolver( resolver );
    }
<% end -%>
<% end -%>
<% end -%>
  }
<% repository.graphql.non_standard_scalars.each do |scalar| -%>

  @javax.annotation.Nullable
  protected graphql.schema.GraphQLScalarType defineScalar_<%= scalar %>()
  {
    return org.realityforge.graphql.domgen.Scalars.<%= Reality::Naming.uppercase_constantize(scalar) %>;
  }
<% end -%>
<% repository.data_modules.select{|data_module| data_module.graphql?}.each do |data_module| -%>
<% data_module.enumerations.select{|enumeration| enumeration.graphql? }.each do |enumeration| -%>

  protected void customizeEnumType_<%= data_module.name %>_<%= enumeration.name %>( @javax.annotation.Nonnull final graphql.schema.GraphQLEnumType.Builder objectType )
  {
  }

  @javax.annotation.Nullable
  protected graphql.schema.GraphQLEnumType defineEnumType_<%= data_module.name %>_<%= enumeration.graphql.name %>()
  {
    final graphql.schema.GraphQLEnumType.Builder enumType = graphql.schema.GraphQLEnumType.newEnum();
    enumType.name( "<%= enumeration.graphql.name %>" );
<% if has_description?(enumeration) -%>
    enumType.description( "<%= description_to_string(enumeration) %>" );
<% end -%>
<% enumeration.values.select{|value| value.graphql?}.each do |value| -%>
    enumType.value( "<%= value.graphql.name %>", "<%= enumeration.graphql.name %>", "<%= description_to_string(value) %>", <%= value.graphql.deprecation_reason ? "\"#{value.graphql.deprecation_reason}\"" : 'null' %> );
<% end -%>
    customizeEnumType_<%= data_module.name %>_<%= enumeration.name %>( enumType );
    return enumType.build();
  }
<% end -%>
<% end -%>
<% repository.data_modules.select{|data_module| data_module.graphql?}.each do |data_module| -%>
<% data_module.entities.select{|entity| entity.graphql? }.each do |entity| -%>
<% entity.attributes.select{|attribute| attribute.graphql?}.each do |attribute| -%>
<% if attribute.abstract? -%>

  private static Object get<%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>( final graphql.schema.DataFetchingEnvironment e )
  {
    final Object source = e.getSource();
    <% attribute.entity.subtypes.select{|st|st.concrete? && st.jpa?}.each do |st| -%>if( source instanceof <%= st.jpa.qualified_name %> )
    {
      return ( (<%= st.jpa.qualified_name %>) source ).<%= getter_for(attribute) %>;
    }
    else <% end %>
    {
      throw new IllegalStateException( "Unable to resolve source object " + source + " to field <%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>" );
    }
  }

  @javax.annotation.Nonnull
  protected graphql.schema.DataFetcher defineDataFetcher_<%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>()
  {
    return <%= repository.graphql.abstract_schema_builder_name %>::get<%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>;
  }
<% else -%>

  @javax.annotation.Nonnull
  protected graphql.schema.DataFetcher defineDataFetcher_<%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>()
  {
    return e -> e.<<%= entity.jpa.qualified_name %>>getSource().<%= getter_for(attribute) %>;
  }
<% end -%>

  @javax.annotation.Nullable
  protected graphql.schema.GraphQLFieldDefinition defineField_<%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>()
  {
    final graphql.schema.GraphQLFieldDefinition.Builder field = graphql.schema.GraphQLFieldDefinition.newFieldDefinition();
    field.name( "<%= attribute.graphql.name %>" );
<% if has_description?(attribute) -%>
    field.description( "<%= description_to_string(attribute) %>" );
<% end -%>
<% if attribute.graphql.deprecation_reason -%>
    field.deprecate( "<%= attribute.graphql.deprecation_reason -%>" );
<% end -%>
<%
  accessor =
    if attribute.reference? && attribute.referenced_entity.qualified_name.to_s == attribute.entity.qualified_name.to_s
      "new graphql.schema.GraphQLTypeReference( \"#{attribute.referenced_entity.graphql.name}\" )"
    elsif attribute.reference? && attribute.referenced_entity.abstract?
      "interfaceType( \"#{attribute.referenced_entity.graphql.name}\" )"
    elsif attribute.reference?
      "objectType( \"#{attribute.referenced_entity.graphql.name}\" )"
    elsif attribute.enumeration?
      "enumType( \"#{attribute.enumeration.graphql.name}\" )"
    else
      "scalarType( \"#{attribute.graphql.scalar_type}\" )"
    end
-%>
    field.type( <% unless attribute.nullable? -%>new graphql.schema.GraphQLNonNull( <% end -%><% if attribute.collection? -%>new graphql.schema.GraphQLList( new graphql.schema.GraphQLNonNull( <% end -%><%= accessor %><% if attribute.collection? -%> ) )<% end %><% unless attribute.nullable? -%> )<% end -%> );
    field.dataFetcher( defineDataFetcher_<%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>() );
    return field.build();
  }
<% end -%>
<% if entity.abstract? -%>

  protected void customizeInterfaceType_<%= data_module.name %>_<%= entity.name %>( @javax.annotation.Nonnull final graphql.schema.GraphQLInterfaceType.Builder interfaceType )
  {
  }

  @javax.annotation.Nonnull
  protected graphql.schema.GraphQLInterfaceType defineInterfaceType_<%= data_module.name %>_<%= entity.name %>()
  {
    final graphql.schema.GraphQLInterfaceType.Builder interfaceType = graphql.schema.GraphQLInterfaceType.newInterface();
    interfaceType.name( "<%= entity.graphql.name %>" );
<% if has_description?(entity) -%>
    interfaceType.description( "<%= description_to_string(entity) %>" );
<% end -%>
<% entity.attributes.select{|attribute| attribute.graphql?}.each do |attribute| -%>
    {
      final graphql.schema.GraphQLFieldDefinition field = defineField_<%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>();
      if( null != field )
      {
        interfaceType.field( field );
      }
    }
<% end -%>
    interfaceType.typeResolver( new graphql.schema.TypeResolverProxy() );
    customizeInterfaceType_<%= data_module.name %>_<%= entity.name %>( interfaceType );
    return interfaceType.build();
  }
<% else -%>

  protected void customizeObjectType_<%= data_module.name %>_<%= entity.name %>( @javax.annotation.Nonnull final graphql.schema.GraphQLObjectType.Builder objectType )
  {
  }

  @javax.annotation.Nonnull
  protected graphql.schema.GraphQLObjectType defineObjectType_<%= data_module.name %>_<%= entity.name %>()
  {
    final graphql.schema.GraphQLObjectType.Builder objectType = graphql.schema.GraphQLObjectType.newObject();
    objectType.name( "<%= entity.graphql.name %>" );
<% entity.supertypes.select{|type| type.graphql? && type.abstract? }.each do |type| -%>
    objectType.withInterface( interfaceType( "<%= type.graphql.name %>" ) );
<% end -%>
<% if has_description?(entity) -%>
    objectType.description( "<%= description_to_string(entity) %>" );
<% end -%>
<% entity.attributes.select{|attribute| attribute.graphql?}.each do |attribute| -%>
    {
      final graphql.schema.GraphQLFieldDefinition field = defineField_<%= data_module.name %>_<%= entity.name %>_<%= attribute.name %>();
      if( null != field )
      {
        objectType.field( field );
      }
    }
<% end -%>
    customizeObjectType_<%= data_module.name %>_<%= entity.name %>( objectType );
    return objectType.build();
  }
<% end -%>
<% end -%>
<% end -%>
}
