/* DO NOT EDIT: File is auto-generated */
package <%= to_package(repository.gwt.qualified_abstract_client_test_name) %>;

@java.lang.SuppressWarnings( { "UnusedDeclaration" } )
@javax.annotation.Generated( "Domgen" )
public abstract class <%= repository.gwt.abstract_client_test_name %>
  extends org.realityforge.guiceyloops.shared.AbstractSharedTest
<% if repository.arez? -%>
  implements org.testng.IHookable
<% end -%>
{
<% if repository.arez? -%>
  private final java.util.ArrayList<String> _observerErrors = new java.util.ArrayList<>();
  private boolean _ignoreObserverErrors;
  private boolean _printObserverErrors;
<% end -%>
<% repository.gwt.test_factories.each do |short_code, classname| -%>
  @javax.annotation.Nonnull
  @edu.umd.cs.findbugs.annotations.SuppressFBWarnings( "NP_NONNULL_FIELD_NOT_INITIALIZED_IN_CONSTRUCTOR" )
  protected <%= classname %> <%= short_code %>;
<% end -%>

  @org.testng.annotations.BeforeMethod
  public void preTest()
    throws Exception
  {
<% if repository.arez? -%>
    org.realityforge.braincheck.BrainCheckTestUtil.resetConfig( false );
    arez.ArezTestUtil.resetConfig( false );
    setIgnoreObserverErrors( false );
    setPrintObserverErrors( true );
    _observerErrors.clear();
    arez.Arez.context().addObserverErrorHandler( this::onObserverError );
<% end -%>
    super.preTest();
<% repository.gwt.test_factories.each do |short_code, classname| -%>
    <%= short_code %> = s( <%= classname %>.class );
<% end -%>
  }
<% if repository.arez? -%>

  @org.testng.annotations.AfterMethod
  protected void afterTest()
    throws Exception
  {
    super.postTest();
    arez.ArezTestUtil.resetConfig( true );
    org.realityforge.braincheck.BrainCheckTestUtil.resetConfig( true );
<% if repository.arez? -%>
    if ( !_ignoreObserverErrors && !_observerErrors.isEmpty() )
    {
      org.testng.Assert.fail( "Unexpected Observer Errors: " + _observerErrors.stream().collect( java.util.stream.Collectors.joining( "\n" ) ) );
    }
<% end -%>
  }

  @Override
  public void run( final org.testng.IHookCallBack icb, final org.testng.ITestResult testResult )
  {
    if( null != testResult.getMethod().getConstructorOrMethod().getMethod().getAnnotation( <%= repository.arez.qualified_no_action_annotation_name %>.class ) )
    {
      icb.runTestMethod( testResult );
    }
    else
    {
      arez.Arez.context().safeAction( testResult.getName(), true, false, () -> icb.runTestMethod( testResult ) );
    }
  }

<% end -%>

  @java.lang.Override
  protected com.google.inject.Module[] getModules()
  {
    final java.util.ArrayList<com.google.inject.Module> modules = new java.util.ArrayList<>();
    java.util.Collections.addAll( modules, super.getModules() );
<% repository.gwt.test_modules.keys.each do |name| -%>
    addModule( modules, new<%= name %>() );
<% end -%>
    return modules.toArray( new com.google.inject.Module[ modules.size() ] );
  }

<% repository.gwt.test_modules.each_pair do |name, classname| -%>

  @javax.annotation.Nullable
  protected com.google.inject.Module new<%= name %>()
  {
    return new <%= classname %>();
  }
<% end -%>
<% if repository.arez? -%>
  protected static void observeDependency()
  {
    arez.Arez.context().observable().reportObserved();
  }

  @javax.annotation.Nonnull
  protected final arez.Disposable pauseScheduler()
  {
    return arez.Arez.context().pauseScheduler();
  }

  protected final void autorun( @javax.annotation.Nonnull final arez.Procedure procedure )
  {
    arez.Arez.context().autorun( () -> {
      observeDependency();
      procedure.call();
    } );
  }

  protected final void action( @javax.annotation.Nonnull final arez.Procedure action )
    throws Throwable
  {
    arez.Arez.context().action( action );
  }

  protected final <T> T action( @javax.annotation.Nonnull final arez.Function<T> action )
    throws Throwable
  {
    return arez.Arez.context().action( action );
  }

  protected final void safeAction( @javax.annotation.Nonnull final arez.SafeProcedure action )
  {
    arez.Arez.context().safeAction( action );
  }

  protected final <T> T safeAction( @javax.annotation.Nonnull final arez.SafeFunction<T> action )
  {
    return arez.Arez.context().safeAction( action );
  }

  protected final void setIgnoreObserverErrors( final boolean ignoreObserverErrors )
  {
    _ignoreObserverErrors = ignoreObserverErrors;
  }

  protected final void setPrintObserverErrors( final boolean printObserverErrors )
  {
    _printObserverErrors = printObserverErrors;
  }

  private void onObserverError( @javax.annotation.Nonnull final arez.Observer observer,
                                @javax.annotation.Nonnull final arez.ObserverError error,
                                @javax.annotation.Nullable final Throwable throwable )
  {
    if ( !_ignoreObserverErrors )
    {
      final String message = "Observer: " + observer.getName() + " Error: " + error + " " + throwable;
      _observerErrors.add( message );
      if ( _printObserverErrors )
      {
        System.out.println( message );
      }
    }
  }
<% end -%>
<% repository.gwt.test_class_contents.each do |content| %>
<%= content -%>
<% end -%>
}
