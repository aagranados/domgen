/* DO NOT EDIT: File is auto-generated */
package <%= to_package(repository.imit.qualified_gwt_data_loader_service_name) %>;

@javax.inject.Singleton
@arez.annotations.ArezComponent
@java.lang.SuppressWarnings( { "unchecked", "PMD.UnusedPrivateField", "PMD.UnusedLocalVariable", "PMD.FieldDeclarationsShouldBeAtStartOfClass", "PMD.SingularField" } )
public abstract class <%= repository.imit.gwt_data_loader_service_name %>
  extends org.realityforge.replicant.client.gwt.<%= repository.imit.poll_replicate_mode? ? 'GwtWebPoller' : 'Gwt' %>DataLoaderService
{
<% if repository.keycloak? -%>
  @edu.umd.cs.findbugs.annotations.SuppressFBWarnings( "DE_MIGHT_IGNORE" )
  protected class ReplicantRequestFactory
    extends org.realityforge.replicant.client.gwt.GwtWebPollerDataLoaderService.ReplicantRequestFactory
  {
    @javax.annotation.Nonnull
    @java.lang.Override
    public org.realityforge.gwt.webpoller.client.Request newRequest( @javax.annotation.Nonnull final org.realityforge.gwt.webpoller.client.RequestContext requestContext )
      throws Exception
    {
      final org.realityforge.gwt.webpoller.client.CancelableRequestWrapper request = new org.realityforge.gwt.webpoller.client.CancelableRequestWrapper();
      updateTokenAndExecute( () ->
        {
          try { request.setRequest( super.newRequest( requestContext ) ); } catch ( final Exception ignored ) {}
        }
      );
      return request;
    }
  }

<% end -%>
  @javax.annotation.Nonnull
  private final <%= repository.imit.qualified_gwt_client_session_context_name %> _context;
  @javax.annotation.Nonnull
  private final <%= repository.imit.qualified_client_router_interface_name %> _router;
  private final <%= repository.imit.qualified_change_mapper_name %> _changeMapper;
  private final org.realityforge.replicant.client.EntityLocator _entityLocator;

  public <%= repository.imit.gwt_data_loader_service_name %>( @javax.annotation.Nonnull final org.realityforge.replicant.client.EntityLocator entityLocator, @javax.annotation.Nonnull final <%= repository.arez.qualified_root_repository_name %> repository, @javax.annotation.Nonnull final <%= repository.imit.qualified_gwt_client_session_context_name %> context, @javax.annotation.Nonnull final <%= repository.imit.qualified_client_router_interface_name %> router )
  {
    super( replicant.Replicant.areZonesEnabled() ? replicant.Replicant.context() : null, <%= repository.imit.qualified_graph_enum_name %>.class, <%= repository.gwt_rpc.qualified_rpc_services_dagger_module_name %>.getSessionContext() );
    _context  = context;
    _router = router;
    _changeMapper = new <%= repository.imit.qualified_change_mapper_name %>( <%= repository.data_modules.select{|data_module| data_module.imit? }.collect { |data_module| "new #{data_module.imit.qualified_mapper_name}( entityLocator, repository.#{Reality::Naming.camelize(data_module.name)}() )" }.join(', ') %> );
    _entityLocator = entityLocator;
  }

  @javax.annotation.Nonnull
  protected String getEndpointOffset()
  {
    return "<%= repository.jaxrs? ? repository.jaxrs.path : 'api' -%>";
  }

  @javax.annotation.Nonnull
  @java.lang.Override
  protected org.realityforge.replicant.client.transport.ChangeMapper getChangeMapper()
  {
    return _changeMapper;
  }

<% if repository.keycloak? -%>
  protected final void updateTokenAndExecute( @javax.annotation.Nonnull final java.lang.Runnable runnable )
  {
    <%= repository.gwt_rpc.qualified_rpc_services_dagger_module_name %>.updateTokenAndExecute( runnable );
  }

  @java.lang.Override
  protected void doConnect( @javax.annotation.Nonnull final replicant.SafeProcedure action )
  {
    updateTokenAndExecute( () -> super.doConnect( action ) );
  }

  @java.lang.Override
  protected void doDisconnect( @javax.annotation.Nonnull final replicant.SafeProcedure action )
  {
    updateTokenAndExecute( () -> super.doDisconnect( action ) );
  }

  @java.lang.Override
  protected void performSubscribe( final int channel,
                                   @javax.annotation.Nullable final java.lang.Integer subChannelId,
                                   @javax.annotation.Nullable final Object filterParameter,
                                   @javax.annotation.Nullable final String cacheKey,
                                   @javax.annotation.Nullable final String eTag,
                                   @javax.annotation.Nonnull final replicant.SafeProcedure onSuccess,
                                   @javax.annotation.Nullable final replicant.SafeProcedure onCacheValid,
                                   @javax.annotation.Nonnull final java.util.function.Consumer<Throwable> onError )
  {
    updateTokenAndExecute( () -> super.performSubscribe( channel, subChannelId, filterParameter, cacheKey, eTag, onSuccess, onCacheValid, onError ) );
  }

  @java.lang.Override
  protected void performUnsubscribe( final int channel, @javax.annotation.Nullable final java.lang.Integer subChannelId, @javax.annotation.Nonnull final replicant.SafeProcedure onSuccess, @javax.annotation.Nonnull final java.util.function.Consumer<java.lang.Throwable> onError )
  {
    updateTokenAndExecute( () -> super.performUnsubscribe( channel, subChannelId, onSuccess, onError ) );
  }
<% end -%>

  @java.lang.SuppressWarnings( { "ConstantConditions", "unchecked" } )
  private boolean doesEntityMatchFilter( @javax.annotation.Nonnull final replicant.ChannelAddress address, @javax.annotation.Nullable final Object rawFilter, @javax.annotation.Nonnull final replicant.Entity entity )
  {
    final java.lang.Enum channelType = address.getChannelType();
    <% repository.imit.graphs.select{|g| g.filtered?}.each do |graph| -%>
if ( <%= repository.imit.qualified_graph_enum_name %>.<%= Reality::Naming.uppercase_constantize(graph.name) %> == channelType )
    {
      final <%= Domgen::Java.java_type(graph.filter_parameter, :gwt, :default) %> filter = (<%= graph.filter_parameter.struct? ? graph.filter_parameter.referenced_struct.gwt.qualified_jso_name : Domgen::Java.java_type(graph.filter_parameter, :imit, :default) %>) rawFilter;
      assert null != filter;
      final Object userObject = entity.getUserObject();
      assert null != userObject;
<% if graph.instance_root? || (graph.filtered? && graph.routing_keys.size > 0) -%>
      final java.util.Map<java.lang.String, java.io.Serializable> route = _router.route( userObject );
<% end -%>
<%
  extra_interest_filter = ''
  if graph.instance_root?
    entity = repository.entity_by_name(graph.instance_root)
    var_name = Reality::Naming.camelize("#{entity.name}#{entity.primary_key.name}")
    extra_interest_filter = ", #{var_name}"
-%>
      @javax.annotation.Nonnull
      final <%= entity.primary_key.imit.non_primitive_java_type %> <%= var_name %> = (<%= entity.primary_key.imit.non_primitive_java_type %>) route.get( <%= repository.imit.qualified_client_router_interface_name %>.<%= Reality::Naming.uppercase_constantize(graph.name) %>_KEY );
      assert null != <%= var_name %>;
<% end -%>
<%
  if graph.filtered?
    graph.routing_keys.each do |routing_key|
      var_name = Reality::Naming.camelize(routing_key.name)
      nullable = !graph.instance_root? || !(routing_key.imit_attribute.attribute.entity.qualified_name == graph.instance_root)
      param_type = routing_key.target_attribute.imit.non_primitive_java_type
      param_type = "java.util.List<#{param_type}>" if routing_key.multivalued?
      extra_interest_filter << ", #{var_name}"
-%>
      <%= nullability_annotation(nullable) %>
      final <%= param_type %> <%= var_name %> = (<%= param_type %>) route.get( <%= repository.imit.qualified_client_router_interface_name %>.<%= Reality::Naming.uppercase_constantize(graph.name) %>_<%= Reality::Naming.uppercase_constantize(routing_key.name) %>_KEY );
<% if !nullable -%>
      assert null != <%= var_name %>;
<% end -%>
<%
    end
  end
-%>
      return _context.does<%= graph.name %>MatchEntity( filter, userObject<%= extra_interest_filter %> );
    }
    else <% end -%>

    {
      throw new java.lang.IllegalStateException();
    }
  }

  @javax.annotation.Nonnull
  @java.lang.Override
  protected replicant.SubscriptionUpdateEntityFilter getSubscriptionUpdateFilter()
  {
    return ( address, filter, entity ) -> doesEntityMatchFilter( address, filter, entity );
  }
<% if repository.keycloak? -%>

  @javax.annotation.Nonnull
  @java.lang.Override
  protected org.realityforge.gwt.webpoller.client.RequestFactory newRequestFactory()
  {
    return new ReplicantRequestFactory();
  }
<% end -%>
}
