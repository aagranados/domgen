/* DO NOT EDIT: File is autogenerated */

CREATE PROCEDURE <%= data_module.sql.quoted_schema %>.spRemoveCachedMasterQueryPlans
AS
BEGIN
  SET NOCOUNT ON

  DECLARE @PlanHandles TABLE (Handle VARBINARY(64));

  INSERT INTO @PlanHandles(Handle)
    SELECT CP.plan_handle
    FROM sys.dm_exec_cached_plans AS CP
    CROSS APPLY sys.dm_exec_sql_text(CP.plan_handle) AS ST
    WHERE ST.dbid = DB_ID() AND ST.text LIKE '%<%= data_module.sql.quoted_schema %>%'
    OPTION (RECOMPILE);

  DECLARE @PlanHandle VARBINARY(64)

  WHILE (1 = 1)
    BEGIN
      SELECT TOP 1 @PlanHandle = Handle FROM @PlanHandles OPTION (RECOMPILE);
      IF @@ROWCOUNT = 0 BREAK;

      DBCC FREEPROCCACHE (@PlanHandle) WITH NO_INFOMSGS;
      DELETE FROM @PlanHandles WHERE Handle = @PlanHandle
    END
END
